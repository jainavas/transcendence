<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title data-i18n="dashboard.title">Dashboard - Transcendence</title>
    <script>
      // MODIFICAR para que solo redirija si realmente es .html
      if (window.location.pathname.endsWith('.html')) {
        window.location.replace(window.location.pathname.replace('.html', ''));
      }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/textures/capybara.ico" />
    <link href="/dist/styles.css" rel="stylesheet" />
    <!-- Cargar primero las variables de entorno -->
    <script src="/env-config.js"></script>
    <!-- Sistema de internacionalizaci√≥n -->
    <script src="i18n.js"></script>
    <script src="language-selector.js"></script>
    
    <!-- Debug del sistema i18n -->
    <script>
      console.log('üîß Iniciando debug del sistema i18n...');
      
      // Funci√≥n para crear selector manual funcional
      function createWorkingSelector() {
        const container = document.getElementById('language-selector-container');
        if (!container) {
          console.error('‚ùå Container no encontrado');
          return;
        }
        
        container.innerHTML = '<div style="background: rgba(30,30,30,0.95); color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">' +
          'üåç <select id="working-lang-selector" style="padding: 6px 10px; border-radius: 5px; margin-left: 8px; background: white; color: black; border: none; cursor: pointer;">' +
          '<option value="es">üá™üá∏ Espa√±ol</option>' +
          '<option value="en">üá∫üá∏ English</option>' +
          '<option value="fr">üá´üá∑ Fran√ßais</option>' +
          '<option value="de">üá©üá™ Deutsch</option>' +
          '<option value="pt">üáµüáπ Portugu√™s</option>' +
          '</select></div>';
        
        const selector = document.getElementById('working-lang-selector');
        
        // Establecer idioma actual desde localStorage
        const savedLang = localStorage.getItem('transcendence_language') || 'es';
        selector.value = savedLang;
        
        selector.addEventListener('change', function(e) {
          const newLang = e.target.value;
          console.log('üåç Cambiando idioma a:', newLang);
          
          // Guardar en localStorage
          localStorage.setItem('transcendence_language', newLang);
          
          // Cargar traducciones
          fetch('locales/' + newLang + '.json')
            .then(function(response) {
              if (!response.ok) throw new Error('HTTP ' + response.status);
              return response.json();
            })
            .then(function(translations) {
              console.log('‚úÖ Traducciones cargadas:', translations);
              
              // Aplicar traducciones
              const elements = document.querySelectorAll('[data-i18n]');
              elements.forEach(function(element) {
                const key = element.getAttribute('data-i18n');
                const translation = getNestedValue(translations, key);
                if (translation) {
                  element.textContent = translation;
                }
              });
              
              // Actualizar t√≠tulo
              if (translations.dashboard && translations.dashboard.title) {
                document.title = translations.dashboard.title;
              }
              
              // Actualizar atributo lang del HTML
              document.documentElement.lang = newLang;
              
              console.log('‚úÖ Idioma cambiado a:', getLanguageName(newLang));
              showNotification('‚úÖ Idioma cambiado a ' + getLanguageName(newLang));
              
            })
            .catch(function(error) {
              console.error('‚ùå Error cambiando idioma:', error);
              showNotification('‚ùå Error cargando idioma ' + getLanguageName(newLang), true);
            });
        });
        
        console.log('‚úÖ Selector funcional creado');
      }
      
      function getNestedValue(obj, path) {
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length; i++) {
          if (current && current[keys[i]] !== undefined) {
            current = current[keys[i]];
          } else {
            return null;
          }
        }
        return current;
      }
      
      function getLanguageName(code) {
        const names = {
          'es': 'Espa√±ol',
          'en': 'English', 
          'fr': 'Fran√ßais',
          'de': 'Deutsch',
          'pt': 'Portugu√™s'
        };
        return names[code] || code;
      }
      
      function showNotification(message, isError) {
        const notification = document.createElement('div');
        const bgColor = isError ? 'rgba(220, 38, 38, 0.95)' : 'rgba(34, 197, 94, 0.95)';
        notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: ' + bgColor + 
          '; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 10000; ' +
          'backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(function() {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 2500);
      }
      
      // Verificar estado y crear selector
      setTimeout(function() {
        console.log('üîç Estado del sistema:', {
          i18n: !!window.i18n,
          container: !!document.getElementById('language-selector-container')
        });
        
        createWorkingSelector();
        
        // Aplicar idioma guardado al cargar
        const savedLang = localStorage.getItem('transcendence_language');
        if (savedLang && savedLang !== 'es') {
          console.log('üîÑ Aplicando idioma guardado:', savedLang);
          const selector = document.getElementById('working-lang-selector');
          if (selector) {
            selector.value = savedLang;
            selector.dispatchEvent(new Event('change'));
          }
        }
        
      }, 500);
    </script>
    
    <!-- Script de verificaci√≥n y diagn√≥stico -->
    <script>
      console.log('üîç Dashboard HTML cargado:', new Date().toISOString());
      
      // Variable global para comprobar si dashboard.js se carga
      window.dashboardJsLoaded = false;
      window.dashboardCheckCount = 0;
      
      // Timeout para verificar la carga del script principal
      const dashboardCheckInterval = setInterval(() => {
        window.dashboardCheckCount++;
        
        // Detener despu√©s de 5 intentos o si se ha marcado como cargado
        if (window.dashboardJsLoaded || window.stopDashboardCheck || window.dashboardCheckCount > 5) {
          clearInterval(dashboardCheckInterval);
          if (!window.dashboardJsLoaded && !window.stopDashboardCheck) {
            console.error('‚ö†Ô∏è dashboard.js no se carg√≥ correctamente despu√©s de varios intentos');
            document.body.insertAdjacentHTML('afterbegin', 
              `<div class="bg-yellow-100 text-yellow-800 p-3 fixed top-0 left-0 right-0 z-50">
                ‚ö†Ô∏è Advertencia: dashboard.js no se carg√≥ correctamente.
                <button class="ml-2 underline" id="reloadButton">Recargar</button>
              </div>`
            );
            // Usar un eventListener en lugar de onclick inline
            document.getElementById('reloadButton')?.addEventListener('click', () => {
              location.reload();
            });
          }
        }
      }, 1000);
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
  </head>
  <body class="bg-gray-100 font-sans min-h-screen">
    <!-- Barra de navegaci√≥n superior -->
    <nav class="bg-blue-600 text-white shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center py-3">
          <div class="flex items-center">
            <h1 class="text-xl font-bold">Transcender Pong</h1>
          </div>
          <div id="userProfileNav"></div>
        </div>
      </div>
    </nav>
    
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Tarjeta de perfil -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex flex-col items-center">
            <div id="userProfileImage" class="mb-4"></div>
            <h2 id="userName" class="text-xl font-bold mb-1"></h2>
            <p id="userEmail" class="text-gray-600 text-sm mb-4"></p>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded" data-i18n="common.logout">
              Cerrar sesi√≥n
            </button>
          </div>
        </div>
        
        <!-- Tarjeta de bienvenida y juego -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <div id="welcomeMessage" class="text-center mb-6" data-i18n="dashboard.welcome">Bienvenido a Transcendence</div>
          <div class="text-center">
            <a href="/pong.html" id="playPongButton" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold inline-block transition-transform hover:scale-105" data-i18n="dashboard.play_pong">
              üèì Jugar Pong
            </a>
          </div>
          <div class="text-center mt-4">
            <a href="/pong-ia.html" id="playPongButtonIA" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-bold inline-block transition-transform hover:scale-105" data-i18n="dashboard.play_vs_ai">
              ü§ñ Jugar contra IA
            </a>
          </div>
        </div>
        
        <!-- Tarjeta de puntuaciones -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-bold mb-4" data-i18n="dashboard.my_scores">Mis puntuaciones de Pong</h2>
          <div id="pongScores" class="space-y-3">
            <div class="text-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
              <p class="text-gray-500 mt-2" data-i18n="dashboard.loading_scores">Cargando puntuaciones...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Selector de idioma -->
      <div class="fixed top-4 right-4 z-50">
        <div id="language-selector-container" style="min-height: 40px; min-width: 120px; background: rgba(255,0,0,0.1); border: 1px dashed red; padding: 4px;"></div>
      </div>
      
      <!-- Tabla de mejores puntuaciones globales -->
      <div class="mt-8">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-bold mb-4" data-i18n="dashboard.global_scores">Mejores puntuaciones globales</h2>
          <div id="globalHighScores" class="overflow-x-auto">
            <table class="min-w-full bg-white">
              <thead>
                <tr>
                  <th class="py-2 px-4 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Posici√≥n</th>
                  <th class="py-2 px-4 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jugador 1</th>
                  <th class="py-2 px-4 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jugador 2</th>
                  <th class="py-2 px-4 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Puntuaci√≥n</th>
                  <th class="py-2 px-4 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                </tr>
              </thead>
              <tbody id="highScoresList">
                <tr>
                  <td colspan="4" class="py-4 text-center text-gray-500">Cargando mejores puntuaciones...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts incrustados para depuraci√≥n -->
    <script>
      console.log('‚è≥ Antes de cargar dashboard.js:', new Date().toISOString());
      
      // Funci√≥n de carga de emergencia
      function cargarDatosUsuario() {
        console.log("üîÑ Iniciando carga de emergencia");
        
        fetch('http://localhost:3000/user/me', {
          credentials: 'include'
        })
        .then(response => {
          console.log("üì• Respuesta recibida:", response.status);
          return response.json();
        })
        .then(data => {
          console.log("üìä Datos:", data);
          
          if (data.authenticated && data.user) {
            // Actualizar UI
            document.getElementById('userName').textContent = data.user.name || 'Usuario';
            document.getElementById('userEmail').textContent = data.user.email || '';
            
            // Actualizar imagen
            document.getElementById('userProfileImage').innerHTML = `
              <img src="${data.user.picture}" alt="Perfil" 
                class="h-32 w-32 object-cover rounded-full border-4 border-white"
                onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data.user.name)}&size=128&background=random';">
            `;
            
            // Configurar bot√≥n de logout
            document.getElementById('logoutButton').addEventListener('click', function() {
              console.log("üëÜ Click en bot√≥n de logout");
              this.textContent = 'Cerrando sesi√≥n...';
              this.disabled = true;
              
              fetch('http://localhost:3000/auth/logout', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({action: 'logout'})
              })
              .then(() => {
                window.location.href = "/?logout=true";
              })
              .catch(error => {
                console.error("Error al cerrar sesi√≥n:", error);
                this.textContent = 'Cerrar sesi√≥n';
                this.disabled = false;
              });
            });
          } else {
            console.error("‚ö†Ô∏è No autenticado");
            window.location.href = "/";
          }
        })
        .catch(error => {
          console.error("‚ùå Error cargando datos:", error);
        });
      }
      
      // Ejecutar despu√©s de 500ms para dar tiempo a dashboard.js
      setTimeout(function() {
        if (!window.dashboardJsLoaded) {
          console.log("‚ö†Ô∏è dashboard.js no se carg√≥, usando plan B");
          cargarDatosUsuario();
        }
      }, 1500); // FIXED: Increased timeout from 500ms to 1500ms
    </script>
    
    <!-- Script para marcar como cargado -->
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        console.error('‚ùå Error de JavaScript:', message, source, lineno);
        document.body.insertAdjacentHTML('afterbegin', 
          `<div class="bg-red-100 text-red-800 p-3 fixed top-0 left-0 right-0 z-50">
            Error en JavaScript: ${message} (l√≠nea ${lineno})
            <button onclick="location.reload()" class="ml-2 underline">Recargar</button>
          </div>`
        );
        return false;
      };
    </script>
    
    <!-- Cargar el script compilado de dashboard -->
    <script type="module" src="/dist/dashboard.js?v=<?php echo time(); ?>"></script>
    
    <!-- Script para marcar como cargado -->
    <script>
      // Este script se ejecutar√° despu√©s de dashboard.js
      window.dashboardJsLoaded = true;
      console.log('‚úÖ Scripts de p√°gina cargados:', new Date().toISOString());
      
      // A√ëADIR: Desactivar la verificaci√≥n de recarga autom√°tica
      window.stopDashboardCheck = true;
    </script>
  </body>
</html>